#!/usr/bin/env luajit
local table = require 'ext.table'
local gl = require 'gl'
local ig = require 'imgui'
local matrix = require 'matrix'

local App = require 'imgui.appwithorbit'():subclass()
App.viewUseGLMatrixMode = true

local shapeIndex = 1

local sqrt2 = math.sqrt(2)
local sqrt3 = math.sqrt(3)
local _1_sqrt3 = 1 / sqrt3 

local shapes = {
	{
		name = 'tetrahedron',
		vs = matrix{
			{0, 0, 1},
			{0, (2 * sqrt2) / 3, -1 / 3},
			{sqrt2 / sqrt3, -sqrt2 / 3, -1 / 3},
			{-sqrt2 / sqrt3, -sqrt2 / 3, -1 / 3},
		},
		vtxMulTable = {
			{1, 2, 3, 4},	-- {j}, for T1 * v_i = v_j
			{4, 2, 1, 3},
			{1, 4, 2, 3},
			{3, 2, 4, 1},
			{3, 4, 1, 2},
			{2, 4, 3, 1},
			{1, 3, 4, 2},
			{2, 3, 1, 4},
			{4, 3, 2, 1},
			{4, 1, 3, 2},
			{2, 1, 4, 3},
			{3, 1, 2, 4}
		}
	},
	{
		name = 'cube',
		vs = matrix{
			{_1_sqrt3, _1_sqrt3, _1_sqrt3},
			{-_1_sqrt3, _1_sqrt3, _1_sqrt3},
			{_1_sqrt3, -_1_sqrt3, _1_sqrt3},
			{_1_sqrt3, _1_sqrt3, -_1_sqrt3},
			{-_1_sqrt3, -_1_sqrt3, _1_sqrt3},
			{-_1_sqrt3, _1_sqrt3, -_1_sqrt3},
			{_1_sqrt3, -_1_sqrt3, -_1_sqrt3},
			{-_1_sqrt3, -_1_sqrt3, -_1_sqrt3},
		},
		vtxMulTable = {
			{1, 2, 3, 4, 5, 6, 7, 8},
			{3, 5, 7, 1, 8, 2, 4, 6},
			{4, 1, 7, 6, 3, 2, 8, 5},
			{7, 8, 4, 3, 6, 5, 1, 2},
			{7, 3, 8, 4, 5, 1, 6, 2},
			{4, 6, 1, 7, 2, 8, 3, 5},
			{8, 5, 6, 7, 2, 3, 4, 1},
			{4, 7, 6, 1, 8, 3, 2, 5},
			{8, 7, 5, 6, 3, 4, 2, 1},
			{6, 2, 4, 8, 1, 5, 7, 3},
			{6, 8, 2, 4, 5, 7, 1, 3},
			{5, 3, 2, 8, 1, 7, 6, 4},
			{1, 4, 2, 3, 6, 7, 5, 8},
			{6, 4, 8, 2, 7, 1, 5, 3},
			{5, 8, 3, 2, 7, 6, 1, 4},
			{2, 5, 1, 6, 3, 8, 4, 7},
			{2, 1, 6, 5, 4, 3, 8, 7},
			{2, 6, 5, 1, 8, 4, 3, 7},
			{3, 7, 1, 5, 4, 8, 2, 6},
			{3, 1, 5, 7, 2, 4, 8, 6},
			{8, 6, 7, 5, 4, 2, 3, 1},
			{1, 3, 4, 2, 7, 5, 6, 8},
			{5, 2, 8, 3, 6, 1, 7, 4},
			{7, 4, 3, 8, 1, 6, 5, 2}
		},
	},
	{
		name = 'octahedron',
		vs = matrix{
			{1, 0, 0},
			{0, 0, 1},
			{0, 1, 0},
			{0, -1, 0},
			{0, 0, -1},
			{-1, 0, 0},
		},
		vtxMulTable={
			{1, 2, 3, 4, 5, 6},
			{1, 4, 2, 5, 3, 6},
			{5, 1, 3, 4, 6, 2},
			{1, 5, 4, 3, 2, 6},
			{5, 4, 1, 6, 3, 2},
			{1, 3, 5, 2, 4, 6},
			{5, 6, 4, 3, 1, 2},
			{3, 5, 1, 6, 2, 4},
			{6, 4, 5, 2, 3, 1},
			{5, 3, 6, 1, 4, 2},
			{3, 6, 5, 2, 1, 4},
			{6, 2, 4, 3, 5, 1},
			{2, 3, 1, 6, 4, 5},
			{6, 5, 3, 4, 2, 1},
			{2, 4, 6, 1, 3, 5},
			{3, 2, 6, 1, 5, 4},
			{6, 3, 2, 5, 4, 1},
			{2, 6, 3, 4, 1, 5},
			{2, 1, 4, 3, 6, 5},
			{4, 2, 1, 6, 5, 3},
			{4, 5, 6, 1, 2, 3},
			{3, 1, 2, 5, 6, 4},
			{4, 6, 2, 5, 1, 3},
			{4, 1, 5, 2, 6, 3}
		},
	},
	{
		name = 'dodecahedron',
		vs = matrix{
			{(3 + math.sqrt(5)) / 2, -1, 0},
			{(1 + math.sqrt(5)) / 2, -(1 + math.sqrt(5)) / 2, (1 + math.sqrt(5)) / 2},
			{(3 + math.sqrt(5)) / 2, 1, 0},
			{(1 + math.sqrt(5)) / 2, -(1 + math.sqrt(5)) / 2, -(1 + math.sqrt(5)) / 2},
			{1, 0, (3 + math.sqrt(5)) / 2},
			{(1 + math.sqrt(5)) / 2, (1 + math.sqrt(5)) / 2, (1 + math.sqrt(5)) / 2},
			{0, -(3 + math.sqrt(5)) / 2, 1},
			{0, -(3 + math.sqrt(5)) / 2, -1},
			{(1 + math.sqrt(5)) / 2, (1 + math.sqrt(5)) / 2, -(1 + math.sqrt(5)) / 2},
			{1, 0, -(3 + math.sqrt(5)) / 2},
			{-1, 0, (3 + math.sqrt(5)) / 2},
			{-(1 + math.sqrt(5)) / 2, -(1 + math.sqrt(5)) / 2, (1 + math.sqrt(5)) / 2},
			{0, (3 + math.sqrt(5)) / 2, 1},
			{0, (3 + math.sqrt(5)) / 2, -1},
			{-(1 + math.sqrt(5)) / 2, -(1 + math.sqrt(5)) / 2, -(1 + math.sqrt(5)) / 2},
			{-1, 0, -(3 + math.sqrt(5)) / 2},
			{-(1 + math.sqrt(5)) / 2, (1 + math.sqrt(5)) / 2, (1 + math.sqrt(5)) / 2},
			{-(3 + math.sqrt(5)) / 2, -1, 0},
			{-(1 + math.sqrt(5)) / 2, (1 + math.sqrt(5)) / 2, -(1 + math.sqrt(5)) / 2},
			{-(3 + math.sqrt(5)) / 2, 1, 0}
		} / math.sqrt((9 + 3 * math.sqrt(5)) / 2),
		vtxMulTable = {
			{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20},
			{2, 3, 4, 5, 1, 7, 8, 9, 10, 6, 12, 13, 14, 15, 11, 17, 18, 19, 20, 16},
			{14, 20, 17, 12, 6, 9, 8, 15, 2, 11, 16, 3, 10, 7, 1, 19, 18, 4, 13, 5},
			{3, 4, 5, 1, 2, 8, 9, 10, 6, 7, 13, 14, 15, 11, 12, 18, 19, 20, 16, 17},
			{20, 17, 12, 6, 14, 8, 15, 2, 11, 9, 3, 10, 7, 1, 16, 18, 4, 13, 5, 19},
			{4, 5, 1, 2, 3, 9, 10, 6, 7, 8, 14, 15, 11, 12, 13, 19, 20, 16, 17, 18},
			{17, 12, 6, 14, 20, 15, 2, 11, 9, 8, 10, 7, 1, 16, 3, 4, 13, 5, 19, 18},
			{16, 18, 13, 7, 15, 9, 11, 3, 12, 10, 4, 6, 8, 2, 17, 19, 5, 14, 1, 20},
			{5, 18, 3, 9, 7, 15, 1, 20, 16, 2, 17, 11, 8, 14, 19, 4, 12, 10, 6, 13},
			{5, 1, 2, 3, 4, 10, 6, 7, 8, 9, 15, 11, 12, 13, 14, 20, 16, 17, 18, 19},
			{12, 6, 14, 20, 17, 2, 11, 9, 8, 15, 7, 1, 16, 3, 10, 13, 5, 19, 18, 4},
			{18, 13, 7, 15, 16, 11, 3, 12, 10, 9, 6, 8, 2, 17, 4, 5, 14, 1, 20, 19},
			{18, 3, 9, 7, 5, 1, 20, 16, 2, 15, 11, 8, 14, 19, 17, 12, 10, 6, 13, 4},
			{17, 19, 14, 8, 11, 10, 12, 4, 13, 6, 5, 7, 9, 3, 18, 20, 1, 15, 2, 16},
			{19, 4, 10, 8, 1, 2, 16, 17, 3, 11, 12, 9, 15, 20, 18, 13, 6, 7, 14, 5},
			{1, 19, 4, 10, 8, 11, 2, 16, 17, 3, 18, 12, 9, 15, 20, 5, 13, 6, 7, 14},
			{6, 4, 17, 2, 8, 1, 14, 5, 19, 20, 18, 16, 15, 7, 13, 12, 3, 11, 9, 10},
			{6, 14, 20, 17, 12, 11, 9, 8, 15, 2, 1, 16, 3, 10, 7, 5, 19, 18, 4, 13},
			{13, 7, 15, 16, 18, 3, 12, 10, 9, 11, 8, 2, 17, 4, 6, 14, 1, 20, 19, 5},
			{3, 9, 7, 5, 18, 20, 16, 2, 15, 1, 8, 14, 19, 17, 11, 10, 6, 13, 4, 12},
			{19, 14, 8, 11, 17, 12, 4, 13, 6, 10, 7, 9, 3, 18, 5, 1, 15, 2, 16, 20},
			{4, 10, 8, 1, 19, 16, 17, 3, 11, 2, 9, 15, 20, 18, 12, 6, 7, 14, 5, 13},
			{4, 17, 2, 8, 6, 14, 5, 19, 20, 1, 16, 15, 7, 13, 18, 3, 11, 9, 10, 12},
			{18, 20, 15, 9, 12, 6, 13, 5, 14, 7, 1, 8, 10, 4, 19, 16, 2, 11, 3, 17},
			{20, 5, 6, 9, 2, 3, 17, 18, 4, 12, 13, 10, 11, 16, 19, 14, 7, 8, 15, 1},
			{13, 12, 11, 15, 14, 20, 19, 18, 17, 16, 3, 2, 1, 5, 4, 10, 9, 8, 7, 6},
			{2, 20, 5, 6, 9, 12, 3, 17, 18, 4, 19, 13, 10, 11, 16, 1, 14, 7, 8, 15},
			{14, 13, 12, 11, 15, 16, 20, 19, 18, 17, 4, 3, 2, 1, 5, 6, 10, 9, 8, 7},
			{7, 5, 18, 3, 9, 2, 15, 1, 20, 16, 19, 17, 11, 8, 14, 13, 4, 12, 10, 6},
			{9, 12, 18, 20, 15, 14, 7, 6, 13, 5, 4, 19, 1, 8, 10, 3, 17, 16, 2, 11},
			{7, 15, 16, 18, 13, 12, 10, 9, 11, 3, 2, 17, 4, 6, 8, 1, 20, 19, 5, 14},
			{9, 7, 5, 18, 3, 16, 2, 15, 1, 20, 14, 19, 17, 11, 8, 6, 13, 4, 12, 10},
			{14, 8, 11, 17, 19, 4, 13, 6, 10, 12, 9, 3, 18, 5, 7, 15, 2, 16, 20, 1},
			{10, 8, 1, 19, 4, 17, 3, 11, 2, 16, 15, 20, 18, 12, 9, 7, 14, 5, 13, 6},
			{17, 2, 8, 6, 4, 5, 19, 20, 1, 14, 15, 7, 13, 18, 16, 11, 9, 10, 12, 3},
			{20, 15, 9, 12, 18, 13, 5, 14, 7, 6, 8, 10, 4, 19, 1, 2, 11, 3, 17, 16},
			{5, 6, 9, 2, 20, 17, 18, 4, 12, 3, 10, 11, 16, 19, 13, 7, 8, 15, 1, 14},
			{12, 11, 15, 14, 13, 19, 18, 17, 16, 20, 2, 1, 5, 4, 3, 9, 8, 7, 6, 10},
			{12, 18, 20, 15, 9, 7, 6, 13, 5, 14, 19, 1, 8, 10, 4, 17, 16, 2, 11, 3},
			{19, 16, 11, 10, 13, 7, 14, 1, 15, 8, 2, 9, 6, 5, 20, 17, 3, 12, 4, 18},
			{16, 1, 7, 10, 3, 4, 18, 19, 5, 13, 14, 6, 12, 17, 20, 15, 8, 9, 11, 2},
			{10, 3, 16, 1, 7, 5, 13, 4, 18, 19, 17, 20, 14, 6, 12, 11, 2, 15, 8, 9},
			{3, 16, 1, 7, 10, 13, 4, 18, 19, 5, 20, 14, 6, 12, 17, 2, 15, 8, 9, 11},
			{15, 14, 13, 12, 11, 17, 16, 20, 19, 18, 5, 4, 3, 2, 1, 7, 6, 10, 9, 8},
			{7, 10, 3, 16, 1, 19, 5, 13, 4, 18, 12, 17, 20, 14, 6, 9, 11, 2, 15, 8},
			{8, 1, 19, 4, 10, 3, 11, 2, 16, 17, 20, 18, 12, 9, 15, 14, 5, 13, 6, 7},
			{8, 6, 4, 17, 2, 20, 1, 14, 5, 19, 13, 18, 16, 15, 7, 10, 12, 3, 11, 9},
			{10, 13, 19, 16, 11, 15, 8, 7, 14, 1, 5, 20, 2, 9, 6, 4, 18, 17, 3, 12},
			{8, 11, 17, 19, 14, 13, 6, 10, 12, 4, 3, 18, 5, 7, 9, 2, 16, 20, 1, 15},
			{2, 8, 6, 4, 17, 19, 20, 1, 14, 5, 7, 13, 18, 16, 15, 9, 10, 12, 3, 11},
			{15, 9, 12, 18, 20, 5, 14, 7, 6, 13, 10, 4, 19, 1, 8, 11, 3, 17, 16, 2},
			{6, 9, 2, 20, 5, 18, 4, 12, 3, 17, 11, 16, 19, 13, 10, 8, 15, 1, 14, 7},
			{11, 15, 14, 13, 12, 18, 17, 16, 20, 19, 1, 5, 4, 3, 2, 8, 7, 6, 10, 9},
			{16, 11, 10, 13, 19, 14, 1, 15, 8, 7, 9, 6, 5, 20, 2, 3, 12, 4, 18, 17},
			{1, 7, 10, 3, 16, 18, 19, 5, 13, 4, 6, 12, 17, 20, 14, 8, 9, 11, 2, 15},
			{13, 19, 16, 11, 10, 8, 7, 14, 1, 15, 20, 2, 9, 6, 5, 18, 17, 3, 12, 4},
			{11, 17, 19, 14, 8, 6, 10, 12, 4, 13, 18, 5, 7, 9, 3, 16, 20, 1, 15, 2},
			{9, 2, 20, 5, 6, 4, 12, 3, 17, 18, 16, 19, 13, 10, 11, 15, 1, 14, 7, 8},
			{11, 10, 13, 19, 16, 1, 15, 8, 7, 14, 6, 5, 20, 2, 9, 12, 4, 18, 17, 3},
			{15, 16, 18, 13, 7, 10, 9, 11, 3, 12, 17, 4, 6, 8, 2, 20, 19, 5, 14, 1},
		},
	},
	{
		name = 'icosahedron',
		vs = matrix{
			{0, (-1+math.sqrt(5))/4, 1/2},
			{1/2, 0, (-1+math.sqrt(5))/4},
			{-1/2, 0, (-1+math.sqrt(5))/4},
			{(-1+math.sqrt(5))/4, 1/2, 0},
			{(1-math.sqrt(5))/4, 1/2, 0},
			{0, (1-math.sqrt(5))/4, 1/2},
			{0, (-1+math.sqrt(5))/4, -1/2},
			{(-1+math.sqrt(5))/4, -1/2, 0},
			{(1-math.sqrt(5))/4, -1/2, 0},
			{1/2, 0, (1-math.sqrt(5))/4},
			{-1/2, 0, (1-math.sqrt(5))/4},
			{0, (1-math.sqrt(5))/4, -1/2},
		} / math.sqrt((5 - math.sqrt(5)) / 8),
		vtxMulTable = {
			{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12},
			{2, 3, 4, 5, 1, 7, 8, 9, 10, 6, 11, 12},
			{12, 2, 10, 6, 4, 11, 7, 5, 1, 9, 8, 3},
			{3, 4, 5, 1, 2, 8, 9, 10, 6, 7, 11, 12},
			{2, 10, 6, 4, 12, 7, 5, 1, 9, 11, 8, 3},
			{4, 5, 1, 2, 3, 9, 10, 6, 7, 8, 11, 12},
			{10, 6, 4, 12, 2, 5, 1, 9, 11, 7, 8, 3},
			{3, 6, 7, 5, 12, 8, 1, 2, 10, 11, 9, 4},
			{2, 9, 11, 6, 3, 7, 4, 12, 1, 8, 5, 10},
			{5, 1, 2, 3, 4, 10, 6, 7, 8, 9, 11, 12},
			{6, 4, 12, 2, 10, 1, 9, 11, 7, 5, 8, 3},
			{6, 7, 5, 12, 3, 1, 2, 10, 11, 8, 9, 4},
			{9, 11, 6, 3, 2, 4, 12, 1, 8, 7, 5, 10},
			{4, 7, 8, 1, 12, 9, 2, 3, 6, 11, 10, 5},
			{10, 11, 7, 4, 3, 5, 12, 2, 9, 8, 1, 6},
			{3, 10, 11, 7, 4, 8, 5, 12, 2, 9, 1, 6},
			{2, 1, 8, 11, 10, 7, 6, 3, 12, 5, 4, 9},
			{4, 12, 2, 10, 6, 9, 11, 7, 5, 1, 8, 3},
			{7, 5, 12, 3, 6, 2, 10, 11, 8, 1, 9, 4},
			{11, 6, 3, 2, 9, 12, 1, 8, 7, 4, 5, 10},
			{7, 8, 1, 12, 4, 2, 3, 6, 11, 9, 10, 5},
			{11, 7, 4, 3, 10, 12, 2, 9, 8, 5, 1, 6},
			{1, 8, 11, 10, 2, 6, 3, 12, 5, 7, 4, 9},
			{5, 8, 9, 2, 12, 10, 3, 4, 7, 11, 6, 1},
			{6, 11, 8, 5, 4, 1, 12, 3, 10, 9, 2, 7},
			{9, 8, 7, 6, 10, 4, 3, 2, 1, 5, 12, 11},
			{4, 6, 11, 8, 5, 9, 1, 12, 3, 10, 2, 7},
			{10, 9, 8, 7, 6, 5, 4, 3, 2, 1, 12, 11},
			{3, 2, 9, 11, 6, 8, 7, 4, 12, 1, 5, 10},
			{2, 12, 5, 8, 9, 7, 11, 10, 3, 4, 6, 1},
			{5, 12, 3, 6, 7, 10, 11, 8, 1, 2, 9, 4},
			{6, 3, 2, 9, 11, 1, 8, 7, 4, 12, 5, 10},
			{8, 1, 12, 4, 7, 3, 6, 11, 9, 2, 10, 5},
			{7, 4, 3, 10, 11, 2, 9, 8, 5, 12, 1, 6},
			{8, 11, 10, 2, 1, 3, 12, 5, 7, 6, 4, 9},
			{8, 9, 2, 12, 5, 3, 4, 7, 11, 10, 6, 1},
			{11, 8, 5, 4, 6, 12, 3, 10, 9, 1, 2, 7},
			{8, 7, 6, 10, 9, 3, 2, 1, 5, 4, 12, 11},
			{12, 5, 8, 9, 2, 11, 10, 3, 4, 7, 6, 1},
			{1, 9, 10, 3, 12, 6, 4, 5, 8, 11, 7, 2},
			{7, 11, 9, 1, 5, 2, 12, 4, 6, 10, 3, 8},
			{1, 5, 7, 11, 9, 6, 10, 2, 12, 4, 3, 8},
			{5, 7, 11, 9, 1, 10, 2, 12, 4, 6, 3, 8},
			{6, 10, 9, 8, 7, 1, 5, 4, 3, 2, 12, 11},
			{9, 1, 5, 7, 11, 4, 6, 10, 2, 12, 3, 8},
			{4, 3, 10, 11, 7, 9, 8, 5, 12, 2, 1, 6},
			{10, 2, 1, 8, 11, 5, 7, 6, 3, 12, 4, 9},
			{3, 12, 1, 9, 10, 8, 11, 6, 4, 5, 7, 2},
			{1, 12, 4, 7, 8, 6, 11, 9, 2, 3, 10, 5},
			{11, 10, 2, 1, 8, 12, 5, 7, 6, 3, 4, 9},
			{9, 2, 12, 5, 8, 4, 7, 11, 10, 3, 6, 1},
			{8, 5, 4, 6, 11, 3, 10, 9, 1, 12, 2, 7},
			{7, 6, 10, 9, 8, 2, 1, 5, 4, 3, 12, 11},
			{9, 10, 3, 12, 1, 4, 5, 8, 11, 6, 7, 2},
			{11, 9, 1, 5, 7, 12, 4, 6, 10, 2, 3, 8},
			{12, 1, 9, 10, 3, 11, 6, 4, 5, 8, 7, 2},
			{12, 4, 7, 8, 1, 11, 9, 2, 3, 6, 10, 5},
			{5, 4, 6, 11, 8, 10, 9, 1, 12, 3, 2, 7},
			{10, 3, 12, 1, 9, 5, 8, 11, 6, 4, 7, 2},
			{12, 3, 6, 7, 5, 11, 8, 1, 2, 10, 9, 4},
		},
	},
}

for _,shape in ipairs(shapes) do
	shape.vtxAdj = {}
	for i=1,#shape.vs do
		shape.vtxAdj[i] = {}
	end
	--[[
	for i=1,3 do	-- only consider minimal transform basis
		local row = vtxMulTable[i]
		for _,j in ipairs(row) do
			shape.vtxAdj[i][j] = true
			shape.vtxAdj[j][i] = true
		end
	end
	print(require'ext.tolua'(shape.vtxAdj))
	--]]
	-- [[
	for i=1,#shape.vs do
		for j=1,#shape.vs do
			shape.vtxAdj[i][j] = true
		end
	end
	--]]
end

function App:initGL()
	App.super.initGL(self)
	gl.glClearColor(1,1,1,1)
	gl.glColor4f(0,0,0,1)
end

App.viewDist = 2

function App:update(...)
	gl.glClear(gl.GL_COLOR_BUFFER_BIT)
	self.view:setup(self.width / self.height)


	local shape = shapes[shapeIndex]

	gl.glEnable(gl.GL_BLEND)
	gl.glBlendFunc(gl.GL_SRC_ALPHA, gl.GL_ZERO)
	gl.glEnable(gl.GL_POINT_SMOOTH)
	gl.glPointSize(3)
	gl.glBegin(gl.GL_POINTS)
	for _,v in ipairs(shape.vs) do
		gl.glVertex3f(table.unpack(v))
	end
	gl.glEnd()

	gl.glBegin(gl.GL_LINES)
	for i,e in ipairs(shape.vtxAdj) do
		for j in pairs(e) do
			gl.glVertex3f(table.unpack(shape.vs[i]))
			gl.glVertex3f(table.unpack(shape.vs[j]))
		end
	end
	gl.glEnd()

	App.super.update(self, ...)
end

function App:updateGUI()
	for i,shape in ipairs(shapes) do
		if ig.igButton(shape.name) then
			shapeIndex = i
		end
	end
end

App():run()
